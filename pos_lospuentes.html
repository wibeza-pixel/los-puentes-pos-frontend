<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Los Puentes Control - Punto de Venta (V25 - Sincronizado Google Sheets)</title>
    <style>
        /* ... (TODO EL CSS ORIGINAL SIN CAMBIOS) ... */
    </style>
</head>
<body>
    <div id="tabs">
        <div class="tab-button" data-tab="tab-venta" onclick="openTab(event, 'tab-venta')">üíµ Punto de Venta</div>
        <div class="tab-button" data-tab="tab-admin" onclick="openTab(event, 'tab-admin')">‚öôÔ∏è Administraci√≥n</div>
        <div class="tab-button" data-tab="tab-informes" onclick="openTab(event, 'tab-informes')">üìä Informes</div>
    </div>

    <div id="app-container">
        
        <div id="tab-venta" class="tab-content"> 
            
            <div id="productos">
                <h2>Camping Los Puentes | Cajero: <span id="cajero-name">Cajero 1</span></h2>
                <h3 style="color: var(--color-secondary); margin-top: 0;">Folio Actual: <span id="folio-display">0000</span> (Hoy: <span id="today-is"></span>)</h3>
                <hr>
                <p>Seleccione servicio:</p>

                <!-- ... rest of productos ... -->
            </div>

            <div id="venta">                
                <div class="header-venta" style="padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="color: var(--color-primary);">Venta Actual</h2>
                    <button onclick="vaciarCarrito()">‚ùå Cancelar Venta</button>
                </div>

                <div id="detalle-transaccion">
                    <p id="empty-cart-message" style="text-align: center; color: #777; margin-top: 50px;">A√∫n no hay √≠tems. Agregue servicios de Piscina/Kayak o use el <strong>Formulario</strong> para Camping.</p>
                </div>
                <!-- resto del tab-venta ... -->
            </div>
        </div>

        <!-- ... admin y otros tabs ... -->

        <div id="tab-informes" class="tab-content">
            <h2>üìä Resumen e Informes de Cuadratura</h2>
            <p>Muestra el resumen de las ventas finalizadas en esta sesi√≥n. <strong>(El historial de ventas se pierde al recargar la p√°gina)</strong></p>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <button onclick="generarReporteDiario()">Actualizar Reporte Diario (Funci√≥n Deshabilitada - Ahora en Google Sheets)</button>
                <button onclick="generarReporteMensual()">Generar Acumulado Mensual (Funci√≥n Deshabilitada - Ahora en Google Sheets)</button>
            </div>

            <p style="color: red; font-weight: bold;">‚ö†Ô∏è NOTA: Las funciones de Reporte Diario/Mensual en esta interfaz ya no son funcionales, pues la informaci√≥n se guarda en su <strong>Google Sheet</strong>.</p>
            <p>Utilice la hoja de c√°lculo de Google para realizar la cuadratura y los reportes acumulados.</p>

            <!-- ... resto del markup ... -->

        </div>
    </div>

    <div id="campingModal" class="modal">
      <div class="modal-content">
        <h2>Detalle de Estancia - <span id="modal-service-name"></span></h2>
        <div>
          <label for="camping-nombre">Nombre de Responsable:</label>
          <input type="text" id="camping-nombre" required>
          <label for="camping-rut">RUT/Pasaporte:</label>
          <input type="text" id="camping-rut" required>
          <label for="camping-celular">N¬∞ de Celular:</label>
          <input type="tel" id="camping-celular" placeholder="Ej: +569XXXXXXXX" required>
          <label for="camping-patente">Patente Veh√≠culo:</label>
          <input type="text" id="camping-patente">
          <label for="camping-cantidad"><span id="camping-label-text">Cantidad de Noches/D√≠as:</span></label>
          <input type="number" id="camping-cantidad" value="1" min="1" required>
          <label for="camping-personas">Cantidad de Personas:</label>
          <input type="number" id="camping-personas" value="1" min="1" required>
          <button type="button" id="add-camping-btn" onclick="addCampingToCart()">A√±adir Estancia a Venta</button>
        </div>
      </div>
    </div>

    <script>
    // ... variables ...

    // Reemplazo de la inicializaci√≥n de folio (inicio seguro)
    function iniciarTurno() {
        let lastFolio = parseInt(localStorage.getItem('lastFolio'));
        if (isNaN(lastFolio)) lastFolio = 1000;
        let startFolio = lastFolio + 1;

        if (localStorage.getItem('lastFolio') === null) {
            let inputFolio = prompt("Por favor, ingrese el Folio Inicial para comenzar su turno:", startFolio.toString());
            if (inputFolio !== null) {
                let parsedFolio = parseInt(inputFolio);
                if (!isNaN(parsedFolio) && parsedFolio > 0) {
                    startFolio = parsedFolio;
                }
            }
        }

        folioActual = startFolio;
        document.getElementById('folio-display').textContent = formatFolio(folioActual);
    }
    // --- FUNCI√ìN PRINCIPAL DE PAGO CON SINCRONIZACI√ìN ---
    async function procesarPago(metodo) {
        if (carrito.length === 0) {
            alert("El carrito est√° vac√≠o. Agregue un √≠tem.");
            return;
        }

        const { totalFinal, subtotal, montoDescuento } = calcularTotales();
        
        // 1. Crear el objeto de Transacci√≥n para el env√≠o (similar a las columnas de la hoja)
        const transaccion = {
            folio: folioActual,
            cajero_id: cajeroId,
            monto_total: totalFinal,
            monto_descuento: montoDescuento,
            metodo_pago: metodo,
            detalle: JSON.parse(JSON.stringify(carrito)) 
        };

        try {
            // 2. Enviar los datos al "Puente" de Google Apps Script
            const response = await fetch(URL_APPS_SCRIPT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(transaccion)
            });

            const result = await response.json();

            if (response.ok && result.status === "success") {
                alert(`‚úÖ Venta Folio N¬∞ ${formatFolio(transaccion.folio)} finalizada y SINCRONIZADA con √©xito.\nTotal Pagado: ${formatCurrency(totalFinal)} (M√©todo: ${metodo})`);
                imprimirCupon(transaccion);
                folioActual++; 
                document.getElementById('folio-display').textContent = formatFolio(folioActual);
                guardarFolio(); 
                vaciarCarrito(false); 
            } else {
                throw new Error(`Error en el servidor de Sheets: ${result.message}`);
            }
        } catch (error) {
            alert(`‚ùå ¬°ERROR CR√çTICO DE SINCRONIZACI√ìN! La venta NO FUE REGISTRADA en la nube. Revise la consola (F12) o su URL de Apps Script. Detalles: ${error.message}`);
            console.error("Fallo al enviar la venta a Google Sheets:", error);
        }
    }
    // ... resto del JS igual ...
    </script>
</body>
</html>